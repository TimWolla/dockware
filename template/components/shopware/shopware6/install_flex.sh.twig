{% block shopware %}

{% block shopware_install %}
## ***********************************************************************
##  INSTALL SHOPWARE
## ***********************************************************************
COPY ./assets/shopware6/DockwareSamplePlugin /var/www/html/custom/plugins/DockwareSamplePlugin

RUN cd /var/www && \
    composer create-project shopware/production:{{ shopware.version }} --no-interaction && \
    cp -a /var/www/production/. /var/www/html && \
    rm -rf /var/www/production && \
    touch /var/www/html/.env.local && \
    sed -i "/APP_ENV=/g" /var/www/html/.env.local && \
    sed -i "/APP_URL=/g" /var/www/html/.env.local && \
    sed -i "/DATABASE_URL=/g" /var/www/html/.env.local && \
    sed -i "/MAILER_URL=/g" /var/www/html/.env.local && \
    echo "APP_ENV=dev" >> /var/www/html/.env.local && \
    echo "APP_URL=http://localhost" >> /var/www/html/.env.local && \
    echo "DATABASE_URL=mysql://{{ db.user }}:{{ db.pwd }}@{{ db.host }}:{{ db.port }}/{{ db.database }}" >> /var/www/html/.env.local && \
    echo "MAILER_DSN=smtp://127.0.0.1:1025" >> /var/www/html/.env.local

RUN sudo service mysql start && \
    # switch to default PHP before installing
    sudo update-alternatives --set php /usr/bin/php{{ php.default_version }} > /dev/null 2>&1 && \
    # -------------------------------------------------------------------------------------------
    cd /var/www/html &&\
    php bin/console system:install --create-database --basic-setup && \
    # make sure assets like logos are ready
    php bin/console assets:install && \
    composer require fakerphp/faker && \
    composer require mbezhanov/faker-provider-collection && \
    composer require maltyxx/images-generator && \
    APP_ENV=prod php bin/console framework:demodata && \
    # -------------------------------------------------------------------------------------------
    #cd /var/www/html && APP_ENV=prod php bin/console plugin:refresh && \
    # -------------------------------------------------------------------------------------------
    php bin/console plugin:install DockwareSamplePlugin && \
    php bin/console plugin:activate DockwareSamplePlugin && \
    # -------------------------------------------------------------------------------------------
    # clear cache and refresh dal index to show the new demo data
    php bin/console cache:clear && \
    cd /var/www/html/bin && ./build-storefront.sh && \
    cd /var/www/html && php bin/console theme:change --all --no-compile --no-interaction Storefront && \
    php bin/console theme:compile && \
    php bin/console dal:refresh:index && \
    rm -rf /var/www/html/var/cache/* && \
    # -------------------------------------------------------------------------------------------
    mysql --user={{ db.user }} --password={{ db.pwd }} -e "use {{ db.database }}; INSERT INTO system_config (id, configuration_key, configuration_value, sales_channel_id, created_at, updated_at) VALUES (X'b3ae4d7111114377af9480c4a0911111', 'core.frw.completedAt', '{\"_value\": \"2019-10-07T10:46:23+00:00\"}', NULL, '2019-10-07 10:46:23.169', NULL);" && \
    # -------------------------------------------------------------------------------------------
    sudo service mysql stop \
{% endblock %}

{% endblock %}